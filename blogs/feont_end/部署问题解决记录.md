# Vue3项目部署到Nginx Proxy Manager问题解决记录

## 项目概述
- **项目**：Vue3 + Vite + Element Plus + Ant Design Vue 的门户网站
- **部署目标**：Nginx Proxy Manager
- **API后端**：http://music.qilemusic.cn:10791/api

## 遇到的问题

### 1. 初始部署错误
**现象**：网站访问显示 "Internal server error"

**原因分析**：
1. **静态资源路径错误**：构建后的`dist/index.html`包含了开发环境的静态资源引用
   ```html
   <script src="./src/assets/js/jquery-3.6.0.min.js"></script>
   <!-- 这些文件在构建后不存在 -->
   ```

2. **硬编码URL问题**：App.vue中包含localhost地址
   ```javascript
   icon="http://localhost:5176/src/assets/img/yh-logo.png"
   ```

**解决方案**：
- 清理`index.html`中所有无用的静态资源引用
- 修改硬编码URL为相对路径：`icon="/src/assets/img/yh-logo.png"`

### 2. API代理404错误
**现象**：前端页面加载正常，但所有API请求返回404
```
[18/Aug/2025:08:54:37 +0000] - 404 404 - GET https portal.yuxindazhineng.com "/api/link/getAll"
[18/Aug/2025:08:54:39 +0000] - 404 404 - POST https portal.yuxindazhineng.com "/api/products/getByFuture"
```

**错误的Nginx配置**：
```nginx
location /api/ {
    rewrite ^/api/(.*)$ /$1 break;  # ❌ 这行导致路径重复
    proxy_pass http://music.qilemusic.cn:10791/api/;
}
```

**路径处理逻辑错误**：
1. 前端请求：`/api/link/getAll`
2. rewrite规则：`^/api/(.*)$ /$1` → `/link/getAll`  
3. proxy_pass拼接：`http://music.qilemusic.cn:10791/api/` + `link/getAll`
4. **最终请求**：`http://music.qilemusic.cn:10791/api/link/getAll` ✅

但由于rewrite和proxy_pass的组合使用方式错误，实际可能产生路径重复问题。

**正确的Nginx配置**：
```nginx
location /api/ {
    # 直接代理，不需要rewrite
    proxy_pass http://music.qilemusic.cn:10791/api/;
    proxy_http_version 1.1;
    proxy_set_header Host music.qilemusic.cn;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # CORS处理
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
    add_header Access-Control-Allow-Headers "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,token,code";
    
    if ($request_method = 'OPTIONS') {
        return 204;
    }
}
```

## 本地vs生产环境对比

### Vite开发服务器配置
```javascript
// vite.config.js
proxy: {
    '/api': {
        target: 'http://music.qilemusic.cn:10791/api',
        changeOrigin: true,
        rewrite: (path) => {
            return path.replace(/\/api/, '') // 去掉/api前缀
        }
    }
}
```
**处理逻辑**：`/api/link/getAll` → `http://music.qilemusic.cn:10791/api` + `/link/getAll`

### 生产环境Nginx配置
```nginx
location /api/ {
    proxy_pass http://music.qilemusic.cn:10791/api/;
    # 其他配置...
}
```
**处理逻辑**：`/api/link/getAll` → `http://music.qilemusic.cn:10791/api/link/getAll`

两种配置达到相同效果，但实现方式不同。

## 关键经验教训

### 1. Nginx proxy_pass路径规则
- `proxy_pass http://backend/api/;` （以/结尾）：会替换location中的路径
- `proxy_pass http://backend/api` （不以/结尾）：会追加整个URI

### 2. rewrite + proxy_pass组合使用陷阱
- 当同时使用rewrite和proxy_pass时，要特别注意路径的处理顺序
- 简单的代理场景，直接使用proxy_pass即可，无需rewrite

### 3. 调试方法
1. **查看Nginx访问日志**：确认请求是否到达以及返回状态码
2. **对比本地开发环境**：确保生产环境的代理逻辑与开发环境一致
3. **测试API端点**：直接访问后端API确认服务可用性

### 4. 部署检查清单
- [ ] 清理构建文件中的开发环境引用
- [ ] 检查硬编码URL和路径
- [ ] 验证API代理配置与开发环境一致
- [ ] 测试静态资源加载
- [ ] 验证API请求正常

## 完整的工作配置

### nginx.conf
```nginx
server {
    listen 80;
    server_name portal.yuxindazhineng.com;
    
    root /var/www/html;
    index index.html;
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }
    
    # Vue Router支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理 - 简单直接的配置
    location /api/ {
        proxy_pass http://music.qilemusic.cn:10791/api/;
        proxy_http_version 1.1;
        proxy_set_header Host music.qilemusic.cn;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS支持
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,token,code";
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
    
    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
}
```

## 总结
这次部署问题的核心在于**对Nginx代理配置理解不够深入**，特别是rewrite和proxy_pass的组合使用。最重要的教训是：
1. **保持配置简单**：能用简单配置解决的，不要过度复杂化
2. **理解工具行为**：深入理解每个配置指令的具体行为
3. **系统性调试**：从日志、网络请求等多个角度分析问题